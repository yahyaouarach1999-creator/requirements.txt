import streamlit as st
import pandas as pd
import re

# 1. SETUP
st.set_page_config(page_title="Arrow Ops Search", layout="wide")

# 2. DATA ENGINE
@st.cache_data
def get_data():
    try:
        return pd.read_csv("sop_data.csv").fillna("")
    except:
        return pd.DataFrame()

df = get_data()

# Initialize Session State
if 'view_mode' not in st.session_state:
    st.session_state.view_mode = 'home'
if 'selected_proc' not in st.session_state:
    st.session_state.selected_proc = None

# --- SEARCH LOGIC WITH WEBSO DETECTION ---
def search_logic(query):
    # Detect WEBSO pattern (e.g., WEBSO followed by numbers)
    if re.search(r"WEBSO\s*\d+", query, re.IGNORECASE):
        # Auto-filter for Unity Order Recovery because that's where WEBSOs live
        return df[df['Process'].str.contains("Order", case=False)]
    
    # Standard keyword search
    return df[df.apply(lambda r: r.astype(str).str.contains(query, case=False).any(), axis=1)]

# --- PAGE 1: GOOGLE-STYLE HOME ---
if st.session_state.view_mode == 'home':
    st.markdown("<br><br><br><div style='text-align: center;'>", unsafe_allow_html=True)
    st.title("üèπ Arrow Ops Terminal")
    query = st.text_input("", placeholder="Search keywords or Enter Order # (e.g. WEBSO 999)...")
    st.markdown("</div>", unsafe_allow_html=True)

    if query:
        results = search_logic(query)
        
        if re.search(r"WEBSO\s*\d+", query, re.IGNORECASE):
            st.success(f"üìç Order Reference Detected: Searching Order Management Protocols...")

        if not results.empty:
            for idx, row in results.iterrows():
                if st.button(f"üìÑ {row['Process']} ({row['System']})", key=f"res_{idx}"):
                    st.session_state.selected_proc = row
                    st.session_state.view_mode = 'detail'
                    st.rerun()
        else:
            st.error("No protocol found for that reference.")

# --- PAGE 2: PROCESS DETAIL ---
elif st.session_state.view_mode == 'detail':
    proc = st.session_state.selected_proc
    if st.button("‚Üê Back to Search"):
        st.session_state.view_mode = 'home'
        st.rerun()
    
    st.divider()
    col1, col2 = st.columns([0.7, 0.3])
    with col1:
        st.caption(f"SYSTEM: {proc['System']}")
        st.header(proc['Process'])
        st.write(proc['Instructions'].replace("<br>", "\n"))
    with col2:
        if proc['Screenshot_URL']:
            st.image(proc['Screenshot_URL'], caption="System Preview")
