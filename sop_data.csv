import streamlit as st
import pandas as pd
import re

# 1. SETUP
st.set_page_config(page_title="Arrow Ops Search", layout="wide")

# 2. DATA ENGINE
@st.cache_data
def get_data():
    try:
        return pd.read_csv("sop_data.csv").fillna("")
    except:
        return pd.DataFrame()

df = get_data()

# Initialize Session State
if 'view_mode' not in st.session_state:
    st.session_state.view_mode = 'home'
if 'selected_proc' not in st.session_state:
    st.session_state.selected_proc = None

# --- SEARCH LOGIC WITH DEEP LINK DETECTION ---
def search_logic(query):
    # Detect WEBSO (e.g., WEBSO12345)
    webso_match = re.search(r"WEBSO\s*(\d+)", query, re.IGNORECASE)
    # Detect SFDC Case (e.g., 00123456)
    case_match = re.search(r"\b\d{8}\b", query) 
    
    if webso_match:
        order_num = webso_match.group(1)
        # Filters specifically for Order Recovery SOP
        return df[df['Process'].str.contains("Order", case=False)], "WEBSO", order_num
    
    if case_match:
        case_num = case_match.group(0)
        # Filters specifically for Case Escalation SOP
        return df[df['Process'].str.contains("Escalation", case=False)], "SFDC", case_num
    
    return df[df.apply(lambda r: r.astype(str).str.contains(query, case=False).any(), axis=1)], None, None

# --- PAGE 1: HOME ---
if st.session_state.view_mode == 'home':
    st.markdown("<br><br><br><div style='text-align: center;'>", unsafe_allow_html=True)
    st.title("üèπ Arrow Ops Terminal")
    query = st.text_input("", placeholder="Enter WEBSO, Case #, or Keyword...")
    st.markdown("</div>", unsafe_allow_html=True)

    if query:
        results, link_type, ref_id = search_logic(query)
        
        # Action Buttons for Detected References
        if link_type == "WEBSO":
            st.success(f"üìç Order {ref_id} Recognized")
            st.link_button(f"üöÄ Open WEBSO {ref_id} in Unity", f"https://unity.arrow.com/orders/{ref_id}")
        
        elif link_type == "SFDC":
            st.success(f"üìç SFDC Case {ref_id} Recognized")
            st.link_button(f"üöÄ Open Case {ref_id} in Salesforce", f"https://arrow.my.salesforce.com/{ref_id}")

        st.divider()

        if not results.empty:
            for idx, row in results.iterrows():
                if st.button(f"üìÑ SOP: {row['Process']} ({row['System']})", key=f"res_{idx}"):
                    st.session_state.selected_proc = row
                    st.session_state.view_mode = 'detail'
                    st.rerun()
        else:
            st.error("No SOP matches found.")

# --- PAGE 2: DETAIL ---
elif st.session_state.view_mode == 'detail':
    proc = st.session_state.selected_proc
    if st.button("‚Üê Back to Results"):
        st.session_state.view_mode = 'home'
        st.rerun()
    
    st.divider()
    col1, col2 = st.columns([0.7, 0.3])
    with col1:
        st.caption(f"SYSTEM: {proc['System']}")
        st.header(proc['Process'])
        st.write(proc['Instructions'].replace("<br>", "\n"))
    with col2:
        if proc['Screenshot_URL']:
            st.image(proc['Screenshot_URL'], caption="System Preview")
